<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pantoja Tile | Master Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #6366f1; --bg: #070b14; --card: rgba(30, 41, 59, 0.6); --text: #f8fafc; --accent: #22c55e; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px;
            -webkit-tap-highlight-color: transparent;
        }

        /* LOGO DIFUMINADO */
        .bg-logo {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70%; opacity: 0.05; filter: blur(8px); z-index: -1; pointer-events: none;
        }

        .container { max-width: 1000px; margin: auto; }

        header { text-align: center; margin-bottom: 30px; }
        .logo-main { width: 80px; filter: drop-shadow(0 0 15px var(--primary)); }

        .section-title { 
            font-weight: 800; font-size: 0.9rem; color: var(--primary); 
            margin: 25px 0 15px; border-left: 4px solid var(--primary); 
            padding-left: 12px; text-transform: uppercase; letter-spacing: 1px;
        }
        
        /* CARD PRINCIPAL */
        .card { 
            background: var(--card); 
            padding: 20px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.1); 
            backdrop-filter: blur(12px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .full { grid-column: span 2; }

        label { display: block; font-size: 10px; color: #94a3b8; margin-bottom: 6px; font-weight: bold; }
        input, select, textarea { 
            width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; 
            background: rgba(15, 23, 42, 0.8); color: white; box-sizing: border-box; font-size: 16px; /* 16px evita zoom en iPhone */
        }

        /* BOTONES */
        .btn { padding: 12px 18px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
        .btn-save { background: var(--primary); color: white; width: 100%; margin-top: 20px; font-size: 16px; box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3); }
        .btn-done { background: rgba(34, 197, 94, 0.15); color: var(--accent); border: 1px solid var(--accent); flex: 1; }
        .btn-print { background: rgba(255, 255, 255, 0.05); color: white; border: 1px solid rgba(255,255,255,0.2); width: 50px; }

        /* TABLA RESPONSIVA (MAGIA MOBILE) */
        .table-container { background: var(--card); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(0,0,0,0.3); padding: 15px; text-align: left; font-size: 11px; color: #94a3b8; }
        td { padding: 15px; border-top: 1px solid rgba(255,255,255,0.05); }

        .badge-id { background: var(--primary); padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }

        /* AJUSTES PARA CELULAR */
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .full { grid-column: span 1; }
            
            /* Ocultamos los encabezados de la tabla en mobile */
            thead { display: none; }
            
            tr { 
                display: block; padding: 15px; 
                border-bottom: 1px solid rgba(255,255,255,0.1); 
                position: relative;
            }
            
            td { 
                display: block; padding: 5px 0; border: none; 
                text-align: left; font-size: 15px;
            }

            td:first-child { margin-bottom: 5px; }
            
            .actions-mobile { 
                display: flex; gap: 10px; margin-top: 10px; 
            }
        }
    </style>
</head>
<body>

    <img src="img/logo.png" class="bg-logo">

    <div class="container">
        <header>
            <img src="img/logo.png" class="logo-main">
            <h2 style="margin:0; letter-spacing: 3px;">PANTOJA <span style="color:var(--primary)">TILE</span></h2>
        </header>

        <div class="section-title">Nueva Orden</div>
        <div class="card">
            <div class="grid">
                <div><label>ID</label><input type="text" id="id_orden" readonly></div>
                <div><label>Presupuesto ($)</label><input type="number" id="presupuesto" placeholder="0.00"></div>
                <div><label>Cliente</label><select id="select_cliente" onchange="autoFillCliente()"></select></div>
                <div><label>Staff</label><select id="select_worker" onchange="autoFillWorker()"></select></div>
                <div class="full"><label>Dirección</label><input type="text" id="direccion"></div>
                <div class="full"><label>Notas</label><textarea id="notas_admin" rows="2"></textarea></div>
            </div>
            <button class="btn btn-save" onclick="guardarOrden()"><i class="fas fa-plus"></i> REGISTRAR</button>
            <input type="hidden" id="h_email_cliente"><input type="hidden" id="h_telefono_cliente">
            <input type="hidden" id="h_servicio_cliente"><input type="hidden" id="h_email_worker">
        </div>

        <div class="section-title">Trabajos Activos</div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Asignado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="lista_trabajos">
                    </tbody>
            </table>
        </div>
    </div>

<script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycby-XYUTC1Bj14atA-g_ms727WXqWnyrKg0DdhmdzFdyrNDDmCNqghVGsYHkUO-BhYsfeQ/exec"; 
    let globalData = {};

    window.onload = async () => {
        try {
            const resId = await fetch(`${URL_SCRIPT}?action=get_next_id`);
            document.getElementById('id_orden').value = await resId.text();
            const resData = await fetch(`${URL_SCRIPT}?action=get_dropdowns`);
            globalData = await resData.json();

            document.getElementById('select_cliente').innerHTML = '<option value="">-- Cliente --</option>' + 
                globalData.clients.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            document.getElementById('select_worker').innerHTML = '<option value="">-- Staff --</option>' + 
                globalData.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');

            cargarTabla();
        } catch(e) { console.log(e); }
    };

    function autoFillCliente() {
        const c = globalData.clients.find(x => x.name === document.getElementById('select_cliente').value);
        if(c) { 
            document.getElementById('h_email_cliente').value = c.email; 
            document.getElementById('h_telefono_cliente').value = c.phone; 
            document.getElementById('h_servicio_cliente').value = c.service; 
        }
    }

    function autoFillWorker() {
        const w = globalData.users.find(x => x.name === document.getElementById('select_worker').value);
        if(w) document.getElementById('h_email_worker').value = w.email;
    }

    async function cargarTabla() {
        const res = await fetch(URL_SCRIPT);
        const trabajos = await res.json();
        const tbody = document.getElementById('lista_trabajos');
        tbody.innerHTML = trabajos.filter(t => t.estatus === 'active').map(t => `
            <tr>
                <td><span class="badge-id">${t.id}</span> <span style="color:var(--accent); font-weight:bold; margin-left:10px;">$${t.presupuesto || '0'}</span></td>
                <td><i class="fas fa-user" style="font-size:12px; color:var(--primary)"></i> <b>${t.nombre_cliente}</b><br><small>${t.servicio}</small></td>
                <td><i class="fas fa-hard-hat" style="font-size:12px; color:var(--primary)"></i> ${t.asignado_a}</td>
                <td>
                    <div class="actions-mobile">
                        <button class="btn btn-done" onclick="cambiarEstatus('${t.id}')"><i class="fas fa-check"></i> DONE</button>
                        <button class="btn btn-print" onclick="imprimirReporte('${JSON.stringify(t).replace(/"/g, '&quot;')}')"><i class="fas fa-file-invoice"></i></button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    async function guardarOrden() {
        const btn = document.querySelector('.btn-save');
        btn.disabled = true; btn.innerHTML = "Guardando...";
        const payload = {
            action: 'CREATE_ORDER', id: document.getElementById('id_orden').value,
            presupuesto: document.getElementById('presupuesto').value, cliente: document.getElementById('select_cliente').value,
            email_cliente: document.getElementById('h_email_cliente').value, telefono: document.getElementById('h_telefono_cliente').value,
            direccion: document.getElementById('direccion').value, servicio: document.getElementById('h_servicio_cliente').value,
            description_admin: document.getElementById('notas_admin').value, asignado_a: document.getElementById('select_worker').value,
            email_trabajador: document.getElementById('h_email_worker').value
        };
        await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        location.reload();
    }

    async function cambiarEstatus(id) {
        if(!confirm("¿Finalizar proyecto?")) return;
        await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'CHANGE_STATUS', id: id }) });
        location.reload();
    }

    async function imprimirReporte(dataRaw) {
        const t = JSON.parse(dataRaw);
        const res = await fetch(`${URL_SCRIPT}?action=get_total_hours&orderId=${t.id}`);
        const horas = await res.text();
        const win = window.open('', '', 'width=800,height=900');
        win.document.write(`
            <html><body style="font-family:sans-serif; padding:30px; text-align:center;">
                <img src="img/logo.png" style="width:80px;">
                <h2>PANTOJA TILE - REPORT</h2>
                <hr>
                <p align="left"><strong>ID:</strong> ${t.id}<br><strong>CLIENTE:</strong> ${t.nombre_cliente}<br><strong>DIRECCIÓN:</strong> ${t.direccion}</p>
                <div style="background:#f0f0f0; padding:20px; border-radius:10px;">
                    <h3>HORAS: ${horas} | VALOR: $${t.presupuesto}</h3>
                </div>
                <script>window.onload=()=>{window.print();window.close();}<\/script>
            </body></html>
        `);
    }
</script>
</body>
</html>
