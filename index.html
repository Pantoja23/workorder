<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pantoja Elite | Master Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #6366f1; 
            --bg: #070b14; 
            --card: rgba(30, 41, 59, 0.7); 
            --text: #f8fafc; 
            --accent: #22c55e; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --neon-blue: #00c8ff; 
            --neon-green: #00ff8c; 
            --neon-red: #ff0055;
        }

        header h2, .section-title, .btn-save, #master_switcher, .logo-main {
            transition: color 0.6s ease, border-color 0.6s ease, filter 0.6s ease, box-shadow 0.6s ease;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px; 
            background-image: radial-gradient(circle at top right, #1e1b4b, #070b14); 
            background-attachment: fixed; 
        }

        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: auto; padding-bottom: 50px; }
        header { text-align: center; margin: 15px 0; position: relative; }
        
        .logo-main { 
            height: 60px; 
            filter: drop-shadow(0 0 15px var(--primary)); 
        }
        
        .auth-btn {
            background: linear-gradient(45deg, #d4af37, #b8860b);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
        }
        
        #refresh-timer { 
            position: absolute; right: 0; top: 0; background: rgba(99, 102, 241, 0.1); 
            padding: 8px 15px; border-radius: 20px; font-size: 11px; border: 1px solid var(--primary); 
            color: var(--primary); font-weight: bold;
        }

        .section-title { 
            font-weight: 800; font-size: 0.75rem; color: var(--primary); margin: 25px 0 10px; 
            border-left: 4px solid var(--primary); padding-left: 12px; text-transform: uppercase; 
            display: flex; justify-content: space-between; align-items: center; 
        }

        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .full { grid-column: span 2; }
        
        .status-ok { border: 2px solid var(--neon-green) !important; color: var(--neon-green) !important; box-shadow: 0 0 12px rgba(0, 255, 140, 0.3) !important; }
        .status-lejos { border: 2px solid var(--neon-red) !important; color: var(--neon-red) !important; box-shadow: 0 0 12px rgba(255, 0, 85, 0.3) !important; }

        .staff-tag { padding: 8px 12px; border-radius: 12px; margin: 4px; display: inline-block; font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }

        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: rgba(15, 23, 42, 0.8); color: white; font-size: 14px; box-sizing: border-box; outline: none; }
        .table-container { background: var(--card); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: rgba(0,0,0,0.4); padding: 15px; text-align: left; font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        td { padding: 18px; border-top: 1px solid rgba(255,255,255,0.05); }

        .btn { padding: 10px 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 12px; }
        .btn-save { background: var(--primary); color: white; width: 100%; margin-top: 15px; justify-content: center; }
        .btn-pay-global { background: var(--warning); color: #000; }
        .done-btn { background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .add-btn { background: var(--primary); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }

        #view_login { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        @keyframes parpadeo-alerta {
          0% { transform: scale(1); box-shadow: 0 0 5px #ef4444; }
          50% { transform: scale(1.05); box-shadow: 0 0 15px #ef4444; }
          100% { transform: scale(1); box-shadow: 0 0 5px #ef4444; }
        }
        .alerta-roja { animation: parpadeo-alerta 1s infinite; border: 2px solid white !important; }

        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
        }
    </style>
</head>
<body>

    <div id="view_login">
        <div class="card" style="width: 300px; text-align: center;">
            <img src="img/logo.png" style="width: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--primary));">
            <h2 style="letter-spacing: 2px;">PANTOJA <span style="color:var(--primary)">ADMIN</span></h2>
            <input type="text" id="login_email" placeholder="Usuario / Email" style="margin-bottom: 10px; width: 100%;">
            <div style="position: relative; width: 100%; margin-bottom: 15px;">
    <input type="password" id="login_pass" placeholder="Contrase√±a" style="width: 100%; padding-right: 40px;">
    <span onclick="togglePass()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary); z-index: 10;">
        <i id="eye_icon" class="fas fa-eye"></i>
    </span>
</div>
            <button onclick="handleLogin()" class="btn btn-save" style="width: 100%;">ACCEDER AL PANEL</button>
            <div id="msg_login" style="font-size: 11px; margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="view_main" class="container hidden">
        <header>
            <div id="refresh-timer">Pr√≥ximo refresh: <span id="secs">15</span>s</div>
            <img src="img/logo.png" id="logo_empresa" class="logo-main">
            <h2 id="header_titulo" style="margin:0; letter-spacing: 2px; font-weight: 900; text-transform: uppercase;">
                <span id="nombre_empresa_dinamico" style="color:var(--primary);">PANTOJA ADMIN</span>
            </h2>
            <small id="txt_bienvenida" style="color: var(--text); font-weight: bold; opacity: 0.7;"></small>
            <button onclick="logout()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 10px; font-weight: bold; display: block; margin: 5px auto;">[ CERRAR SESI√ìN ]</button>
        </header>

        <div class="section-title">Registro de Orden</div>
        <div class="card">
            <div class="grid">
                <div><label>ID ORDEN</label><input type="text" id="id_orden" readonly></div>
                <div><label>PRESUPUESTO ($)</label><input type="number" id="presupuesto"></div>
                <div><label>CLIENTE</label><select id="select_cliente" onchange="autoFillCliente()"></select></div>
                <div><label>STAFF INICIAL</label><select id="select_worker" onchange="autoFillWorker()"></select></div>
                <div class="full"><label>DIRECCI√ìN</label><input type="text" id="direccion"></div>
                <div class="full"><label>NOTAS ADMIN</label><textarea id="notas_admin" rows="2"></textarea></div>
            </div>
            <button class="btn btn-save" onclick="guardarOrden()"><i class="fas fa-plus-circle"></i> CREAR PROYECTO</button>
            <input type="hidden" id="h_email_cliente">
            <input type="hidden" id="h_telefono_cliente">
            <input type="hidden" id="h_servicio_cliente">
            <input type="hidden" id="h_email_worker">
        </div>

        <div class="section-title">
            Proyectos Activos 
            <button class="btn btn-pay-global" onclick="abrirModalNominaGlobal()"><i class="fas fa-file-invoice-dollar"></i> GENERAR N√ìMINA</button>
        </div>

        <div id="dashboard_conteo" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 20px;"></div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Proyecto / Cliente</th><th>Equipo & GPS Status</th><th>Finanzas</th><th>Acciones</th></tr>
                </thead>
                <tbody id="lista_trabajos"></tbody>
            </table>
        </div>
    </div>

    <div id="modalSelectPay" class="modal">
        <div class="card" style="width:95%; max-width:450px;">
            <h3 style="color:var(--warning); text-align:center;">Payroll System</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div style="flex:1"><label>DESDE</label><input type="date" id="pay_start_date"></div>
                <div style="flex:1"><label>HASTA</label><input type="date" id="pay_end_date"></div>
            </div>
            
            <label>TRABAJADOR ESPEC√çFICO</label>
            <select id="pay_select_worker" style="margin-bottom:20px;"></select>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn btn-pay-global" onclick="llamarNomina(false)">
                    <i class="fas fa-user"></i> INDIVIDUAL
                </button>
                <button class="btn" style="background:var(--accent); color:white;" onclick="llamarNomina(true)">
                    <i class="fas fa-users"></i> TODOS (MASIVA)
                </button>
                <button class="btn" style="grid-column: span 2; background:var(--danger); color:white; justify-content: center;" onclick="cerrarModales()">
                    CERRAR
                </button>
            </div>
        </div>
    </div>

    <div id="modalWorker" class="modal">
        <div class="card" style="width:90%; max-width:400px;">
            <h3>Asignar Refuerzo</h3>
            <select id="modal_select_worker" style="margin:15px 0;"></select>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:var(--accent); color:white;" onclick="confirmarNuevoStaff()">ASIGNAR</button>
                <button class="btn" style="flex:1; background:var(--danger); color:white;" onclick="cerrarModales()">SALIR</button>
            </div>
            <input type="hidden" id="modal_order_id">
        </div>
    </div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyS8ti1Ok1LAKGxNBK4MNeseS3RV0jMQf2TTzzjbIOPNKkcoeePpcPWrvzp7ai1GEI/exec"; 
let globalData = { clients: [], users: [], rawJobs: [] };
let timerRef = 15;
let session = null;
let masterCompanyData = {};

window.onload = async () => {
    const saved = localStorage.getItem('panto_session');
    if (saved) {
        session = JSON.parse(saved);
        if (session && session.success) {
            // 1. Configurar la empresa inmediatamente en memoria
            await cargarConfiguracionEmpresaIndividual();
            
            // 2. Aplicar el tema y nombre ANTES de mostrar nada
            aplicarTemaEmpresa(session.compania);
            const txtEmpresa = document.getElementById('nombre_empresa_dinamico');
            if(txtEmpresa) txtEmpresa.innerText = session.compania;

            // 3. Cambiar vistas
            document.getElementById('view_login').classList.add('hidden');
            document.getElementById('view_main').classList.remove('hidden');
            
            // 4. Mostrar el cuerpo de la p√°gina ya "tuneado"
            document.body.classList.add('visible-ready');

            if (["Master", "Supervisor", "Admin", "LandLord"].includes(session.rol)) {
                await initMasterTools();
            }
            
            document.getElementById('txt_bienvenida').innerText = `${session.rol}: ${session.name}`;
            initDashboard();
        } else {
            document.body.classList.add('visible-ready'); // Mostrar login si no hay sesi√≥n
        }
    } else {
        document.body.classList.add('visible-ready');
    }
};

async function generarIdInicial() {
  try {
    const res = await fetch(`${URL_SCRIPT}?action=get_next_id&compania=${encodeURIComponent(session.compania)}`);
    const id = await res.text();
    document.getElementById('id_orden').value = id;
  } catch(e) {
    console.error("No se pudo generar ID", e);
  }
}

async function handleLogin() {
    const email = document.getElementById('login_email').value.trim();
    const pass = document.getElementById('login_pass').value.trim();
    const msg = document.getElementById('msg_login');
    
    if (!email || !pass) {
        alert("Por favor, ingresa tu usuario y contrase√±a");
        return;
    }

    msg.innerText = "Verificando credenciales...";
    msg.style.color = "var(--primary)";

    try {
        const fetchUrl = `${URL_SCRIPT}?action=login_staff&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}&t=${Date.now()}`;
        const res = await fetch(fetchUrl);
        const data = await res.json();
        
        if (data.success) {
            // Si el servidor dijo que s√≠, guardamos y entramos
            data.original_compania = data.compania;
            localStorage.setItem('panto_session', JSON.stringify(data));
            location.reload(); 
        } else {
            // Aqu√≠ se mostrar√° el mensaje de "ACCESO DENEGADO" si es un Worker
            msg.innerText = data.msg || "Usuario o contrase√±a incorrectos";
            msg.style.color = "#ff4444"; // Rojo de alerta
        }
    } catch(e) { 
        console.error("Error de Login:", e);
        msg.innerText = "Error de conexi√≥n con el servidor"; 
        msg.style.color = "var(--danger)";
    }
}

function togglePass() {
    const passInput = document.getElementById('login_pass');
    const icon = document.getElementById('eye_icon');
    if (passInput.type === "password") {
        passInput.type = "text";
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        passInput.type = "password";
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function initDashboard() {
    document.getElementById('txt_bienvenida').innerText = `${session.rol}: ${session.name}`;
    generarIdInicial();
    cargarConfiguracion();
    cargarTabla();
    setInterval(() => {
        timerRef--;
        if(document.getElementById('secs')) document.getElementById('secs').innerText = timerRef;
        if(timerRef <= 0) { timerRef = 15; cargarTabla(); }
    }, 1000);
}

async function switchCompany(newComp) {
    session.compania = newComp;
    localStorage.setItem('panto_session', JSON.stringify(session));
    aplicarTemaEmpresa(newComp);
    const txtEmpresa = document.getElementById('nombre_empresa_dinamico');
    if(txtEmpresa) txtEmpresa.innerText = newComp === "TODAS" ? "VISI√ìN GLOBAL" : newComp;
    await cargarConfiguracion(); 
    cargarTabla();
}

function aplicarTemaEmpresa(nombreComp) {
    let color = (masterCompanyData[nombreComp]?.color) || "#6366f1";
    document.documentElement.style.setProperty('--primary', color);
}

async function cargarTabla() {
    try {
        const res = await fetch(`${URL_SCRIPT}?action=get_active_jobs&userCompania=${encodeURIComponent(session.compania)}&userRol=${session.rol}&userEmail=${encodeURIComponent(session.email)}&t=${Date.now()}`);
        const trabajos = await res.json();
        globalData.rawJobs = trabajos;

        const agrupados = trabajos.reduce((acc, curr) => {
            if (!acc[curr.id]) {
                acc[curr.id] = { 
                    id: curr.id, 
                    cliente: curr.cliente, 
                    presupuesto: curr.presupuesto, 
                    equipo: {}, 
                    compania: curr.compania, 
                    direccion: curr.direccion, 
                    status: curr.status, 
                    notas: curr.notas_admin, 
                    fecha: curr.fecha_creacion, // Viene de la Columna Q v√≠a GS
                    costoLabor: curr.total_labor_cost || 0 
                };
            }
            
            // L√≥gica de GPS y Colores
            let color = "#374151"; let txt = "OFF"; let anim = ""; let linkMapa = "#";
            const tieneJ = curr.log_add_in && String(curr.log_add_in).trim() !== "";
            const tieneL = curr.log_add_out && String(curr.log_add_out).trim() !== "";
            
            const cleanDist = (v) => { 
                if(!v) return null; 
                let m = String(v).match(/[\d.]+/); 
                return m ? parseFloat(m[0]) : null; 
            };
            
            const kDist = cleanDist(curr.log_dist_in); 
            const mDist = cleanDist(curr.log_dist_out);

            if (tieneJ && !tieneL) {
                linkMapa = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(curr.log_add_in)}`;
                if (kDist > 0.2) { color = "#ef4444"; txt = `OUT (${kDist}mi)`; anim = "alerta-roja"; }
                else { color = "#10b981"; txt = `IN (${kDist || 0}mi)`; }
            } else if (tieneJ && tieneL) {
                linkMapa = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(curr.log_add_out)}`;
                color = mDist > 0.2 ? "#f97316" : "#2563eb";
                txt = mDist > 0.2 ? `DONE-AWAY (${mDist}mi)` : "DONE";
            }

            acc[curr.id].equipo[curr.asignado_a] = { 
                nombre: curr.asignado_a, 
                horas: curr.horas_acumuladas || 0, 
                estilo: `background-color: ${color} !important;`, 
                clase: anim, 
                label: txt, 
                mapa: linkMapa
            }; 
            return acc;
        }, {});

        const tabla = document.getElementById("lista_trabajos");
        if (!tabla) return;

        tabla.innerHTML = Object.values(agrupados).map(t => {
            // Bot√≥n de Acci√≥n seg√∫n Estatus
            let botonAccion = (t.status === "ON APPROVAL") 
                ? (["Admin", "Master"].includes(session.rol) 
                    ? `<button class="auth-btn" onclick="cambiarEstatus('${t.id}', 'Active')">AUTHORIZE</button>` 
                    : `<span style="color:var(--warning); font-size:10px; font-weight:bold;">AWAITING...</span>`)
                : `<button class="done-btn" onclick="cambiarEstatus('${t.id}', 'Done')">DONE</button>`;

            // L√≥gica de Finanzas (Solo para Master/Admin)
            let finanzasHTML = "---";
            if (session.rol === "Master" || session.rol === "Admin") {
                const profit = t.presupuesto - t.costoLabor;
                finanzasHTML = `
                    <div class="finance-text" style="text-align:right; font-size:11px;">
                        $${t.presupuesto.toLocaleString()} <small>(B)</small><br>
                        <span style="color:#f59e0b">$${t.costoLabor.toLocaleString()}</span> <small>(L)</small><br>
                        <span class="${profit >= 0 ? 'profit-positive' : 'profit-negative'}" style="font-weight:bold; color:${profit >= 0 ? '#10b981' : '#ef4444'}">
                            $${profit.toFixed(2)}
                        </span>
                    </div>`;
            }

            const fichasEquipo = Object.values(t.equipo).map(e => `
                <div class="staff-tag ${e.clase}" 
                     style="${e.estilo} cursor:pointer; color:white; padding:6px; border-radius:6px; margin:2px; display:inline-block; min-width:90px;" 
                     onclick="window.open('${e.mapa}', '_blank')">
                    <b style="font-size:10px;">${e.nombre}</b><br>
                    <small style="font-size:9px;">${e.label} | ${e.horas}h</small>
                </div>`).join("");

            return `<tr>
                <td style="padding:10px;">
                    <button class="btn-id" onclick="verDetalles('${t.id}', '${t.direccion}', \`${t.notas}\`, '${t.fecha}')">#${t.id}</button>
                    <br><span style="font-size:10px; color:#2563eb; font-weight:bold;">${t.compania}</span><br>
                    <span style="font-size:12px;">${t.cliente}</span>
                </td>
                <td style="padding:10px;">
                    <div style="display:flex; flex-wrap:wrap; gap:5px; align-items:center;">
                        ${fichasEquipo}
                        <button class="add-btn" style="width:28px; height:28px; border-radius:50%; border:1px dashed #ccc; background:none; cursor:pointer;" onclick="prepararAddStaff('${t.id}')">+</button>
                    </div>
                </td>
                <td>${finanzasHTML}</td>
                <td style="text-align:center;">${botonAccion}</td>
            </tr>`;
        }).join("");
    } catch (e) { console.error("Error en cargarTabla:", e); }
}

    function verDetalles(id, direccion, notas, fecha) {
    const mensaje = `üìã WORK ORDER: ${id}\n` +
                    `üìÖ CREADO: ${fecha || 'Sin fecha registrada'}\n` +
                    `--------------------------------------\n` +
                    `üìç DIRECCI√ìN:\n${direccion}\n\n` +
                    `üìù NOTAS ADMIN:\n${notas || 'Sin notas adicionales.'}\n` +
                    `--------------------------------------\n` +
                    `Status: ${session.rol} View`;
    alert(mensaje);
}

async function cargarConfiguracion() {
    try {
        const res = await fetch(`${URL_SCRIPT}?action=get_dropdowns&compania=${encodeURIComponent(session.compania)}&rol=${session.rol}`);
        const data = await res.json();
        globalData.clients = data.clients || [];
        globalData.users = data.users || [];

        const selectCliente = document.getElementById('select_cliente');
        selectCliente.innerHTML = '<option value="">-- Seleccionar Cliente --</option>' + 
            globalData.clients.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

        const selectWorker = document.getElementById('select_worker');
        selectWorker.innerHTML = '<option value="">-- Asignar Staff --</option>' + 
            globalData.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');

        const payWorker = document.getElementById('pay_select_worker');
        if (payWorker) {
            payWorker.innerHTML = '<option value="">-- Todos los Trabajadores --</option>' +
                globalData.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        }
    } catch(e) { console.error("Error cargando dropdowns:", e); }
}

async function llamarNomina(esMasivo) {
    const start = document.getElementById('pay_start_date').value;
    const end = document.getElementById('pay_end_date').value;
    const workerName = document.getElementById('pay_select_worker').value; // Este es el nombre (B)
    const compania = session.compania;

    if (!start || !end) return alert("Faltan fechas");

    // CAMBIO AQU√ç: Enviamos el nombre directamente o "all"
    let busqueda = esMasivo ? "all" : workerName;

    try {
        // Cambiamos el par√°metro a 'workerName' para que sea claro
        const url = `${URL_SCRIPT}?action=get_payroll&workerEmail=${encodeURIComponent(busqueda)}&start=${start}&end=${end}&compania=${encodeURIComponent(compania)}&t=${Date.now()}`;
        
        const res = await fetch(url);
        const result = await res.json();
        const logs = result.logs || [];

        if (logs.length === 0) {
            return alert(`SIN DATOS ENCONTRADOS:\n‚Ä¢ Empresa: ${compania}\n‚Ä¢ Periodo: ${start} al ${end}\n‚Ä¢ Filtro: ${busqueda}`);
        }

        imprimirRecibosFinal(logs, start, end);
    } catch (e) { 
        alert("Error de conexi√≥n: " + e.message); 
    }
}

function imprimirRecibosFinal(datosAgrupados, start, end) {
    // Quitamos el visibility:hidden porque en la ventana nueva no sirve de nada
    let html = `<html><head><title>Payroll_${session.compania}</title><style>
    body { font-family: 'Segoe UI', sans-serif; padding:20px; color: #333; background: #fff; }
    
    .hoja { page-break-after: always; padding: 20px; border-bottom: 1px dashed #ccc; }
    h1 { color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 10px; }
    
    .info-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th { background-color: #f8fafc; color: #475569; font-weight: 600; padding: 12px; border: 1px solid #e2e8f0; }
    td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }

    .total-box { 
        margin-top: 20px; 
        padding: 15px; 
        background: #f1f5f9; 
        text-align: right; 
        font-weight: bold; 
        font-size: 16px; 
        border-radius: 8px;
    }
</style></head><body>`;

    datosAgrupados.forEach(u => {
        const filas = u.detalle.map(d => `
            <tr>
                <td><b>${d.id_orden}</b></td>
                <td>${d.horas} hrs</td>
                <td>$${u.rate}/hr</td>
                <td>$${d.pago}</td>
            </tr>`).join('');

        html += `
        <div class="hoja">
            <h1>PAYROLL RECEIPT</h1>
            <div class="info-header">
                <div>
                    <p><b>Worker:</b> ${u.trabajador}</p>
                    <p><b>Company:</b> ${session.compania}</p>
                </div>
                <div style="text-align:right">
                    <p><b>Period:</b> ${start} to ${end}</p>
                    <p><b>Email:</b> ${u.email}</p>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Total Hours</th>
                        <th>Rate</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>${filas}</tbody>
            </table>
            <div class="total-box">
                Total Hours: ${u.total_horas}h | Total to Pay: $${u.total_pagar}
            </div>
        </div>`;
    });

    html += `</body></html>`;
    
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    
    // Le damos tiempo a que el navegador procese el HTML antes de lanzar el print
    setTimeout(() => {
        win.focus();
        win.print();
    }, 1000);
}

function autoFillCliente() {
    const valorSeleccionado = document.getElementById('select_cliente').value;
    const c = globalData.clients.find(x => x.name === valorSeleccionado);
    if (c) {
        document.getElementById('direccion').value = "";
        const servicioTexto = c.service ? `SERVICIO: ${c.service}. ` : "";
        const notasTexto = c.notes ? `MENSAJE CLIENTE: ${c.notes}` : "";
        document.getElementById('notas_admin').value = servicioTexto + notasTexto;
        if (document.getElementById('h_email_cliente')) document.getElementById('h_email_cliente').value = c.email || "";
        if (document.getElementById('h_telefono_cliente')) document.getElementById('h_telefono_cliente').value = c.phone || "";
        if (document.getElementById('h_servicio_cliente')) document.getElementById('h_servicio_cliente').value = c.service || "";
        generarIdInicial();
    }
}

function autoFillWorker() {
    const w = globalData.users.find(x => x.name === document.getElementById('select_worker').value);
    if(w) document.getElementById('h_email_worker').value = w.email;
}

async function guardarOrden() {
    const btn = event.currentTarget;
    const id = document.getElementById('id_orden').value;
    const presupuesto = document.getElementById('presupuesto').value;
    const cliente = document.getElementById('select_cliente').value;
    const worker = document.getElementById('select_worker').value;
    const direccionVal = document.getElementById('direccion').value;

    if (!presupuesto || parseFloat(presupuesto) <= 0) return alert("Debes ingresar presupuesto");
    if (!direccionVal) return alert("La direcci√≥n est√° vac√≠a");
    if (!cliente || !worker) return alert("Faltan datos cr√≠ticos");

    const payload = {
        action: 'UPDATE_OR_CREATE_ORDER', 
        id: id, status: 'ACTIVE', presupuesto: presupuesto, cliente: cliente,
        direccion: direccionVal, notas_admin: document.getElementById('notas_admin').value,
        asignado_a: worker, email_cliente: document.getElementById('h_email_cliente').value,
        telefono: document.getElementById('h_telefono_cliente').value,
        servicio: document.getElementById('h_servicio_cliente').value,
        email_trabajador: document.getElementById('h_email_worker').value,
        compania: session.compania
    };

    btn.disabled = true;
    btn.innerText = "Autorizando...";

    try {
        const res = await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify(payload) });
        const texto = await res.text();
        if (texto.includes("SUCCESS")) {
            alert("¬°Proyecto #" + id + " Autorizado!");
            location.reload(); 
        } else {
            alert("Error: " + texto);
            btn.disabled = false;
        }
    } catch(e) {
        alert("Error de conexi√≥n");
        btn.disabled = false;
    }
}

async function cambiarEstatus(id, nuevoEstatus) {
    nuevoEstatus = nuevoEstatus.toUpperCase();
    if (nuevoEstatus === 'ACTIVE') {
        const orden = globalData.rawJobs.find(j => String(j.id) === String(id));
        if (!orden) return alert("No encontrada");
        document.getElementById('id_orden').value = orden.id;
        document.getElementById('direccion').value = "";
        document.getElementById('presupuesto').value = "";
        document.getElementById('notas_admin').value = `(F) ${orden.servicio || 'N/A'} - (I) ${orden.notas_admin || ''}`;
        document.getElementById('select_cliente').innerHTML = `<option selected>${orden.cliente}</option>`;
        document.getElementById('select_cliente').disabled = true;
        document.getElementById('select_worker').innerHTML = `<option selected>Jorge Pantoja</option>`;
        document.getElementById('select_worker').disabled = true;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return;
    }
    if (nuevoEstatus === 'DONE') {
        if (!confirm(`¬øFinalizar orden #${id}?`)) return;
        const res = await fetch(`${URL_SCRIPT}?action=cambiar_estatus&id=${id}&nuevo=DONE`);
        const txt = await res.text();
        if (txt.includes("SUCCESS")) { alert("Orden finalizada"); cargarTabla(); }
    }
}

async function initMasterTools() {
    if (session.rol !== "Master") return;
    const res = await fetch(`${URL_SCRIPT}?action=get_companies`);
    const companies = await res.json();
    companies.forEach(c => masterCompanyData[c.nombre] = c);
    if (document.getElementById('master_switcher')) return;
    const header = document.querySelector('header');
    const select = `<div id="master_switcher" style="margin-top: 10px;">
            <select onchange="switchCompany(this.value)" style="padding: 8px; border-radius: 10px; background: #1e293b; color: white; border: 1px solid var(--primary); font-size: 12px;">
                <option value="${session.original_compania}">-- Mi Empresa --</option>
                <option value="TODAS">-- VER TODO (MASTER) --</option>
                ${companies.map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join("")}
            </select></div>`;
    header.insertAdjacentHTML('beforeend', select);
}

async function cargarConfiguracionEmpresaIndividual() {
    const res = await fetch(`${URL_SCRIPT}?action=get_companies`);
    const data = await res.json();
    data.forEach(c => masterCompanyData[c.nombre] = c);
}

function prepararAddStaff(id) {
    document.getElementById('modal_order_id').value = id;
    document.getElementById('modal_select_worker').innerHTML = globalData.users.map(u => `<option value="${u.name}" data-email="${u.email}">${u.name}</option>`).join('');
    document.getElementById('modalWorker').style.display = 'flex';
}

async function confirmarNuevoStaff() {
    const sel = document.getElementById('modal_select_worker');
    const workerName = sel.value;
    const workerEmail = sel.options[sel.selectedIndex].dataset.email;
    const orderId = document.getElementById('modal_order_id').value;

    if (!workerName) return alert("Selecciona un trabajador");

    const payload = {
        action: 'ADD_STAFF',
        id: orderId,
        asignado_a: workerName,
        email_trabajador: workerEmail,
        compania: session.compania
    };

    try {
        const res = await fetch(URL_SCRIPT, { 
            method: 'POST', 
            body: JSON.stringify(payload) 
        });
        const texto = await res.text();

        if (texto.includes("SUCCESS")) {
            cerrarModales();
            // Refrescamos los datos para que aparezca la nueva ficha
            await cargarTabla(); 
            alert(`${workerName} a√±adido al proyecto #${orderId}`);
        } else if (texto.includes("YA ASIGNADO")) {
            alert("Este trabajador ya est√° asignado a este proyecto.");
        } else {
            alert("Error: " + texto);
        }
    } catch (e) {
        alert("Error de conexi√≥n al agregar staff");
    }
}

function cerrarModales() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
function logout() { localStorage.clear(); location.reload(); }
function abrirModalNominaGlobal() { document.getElementById("modalSelectPay").style.display = "flex"; }
</script>
</body>
</html>
