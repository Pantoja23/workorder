<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pantoja Elite | Master Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #6366f1; --bg: #070b14; --card: rgba(30, 41, 59, 0.7); 
            --text: #f8fafc; --accent: #22c55e; --warning: #f59e0b; --danger: #ef4444; 
            --neon-blue: #00c8ff; --neon-green: #00ff8c; --neon-red: #ff0055;
        }

        body { 
            font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; 
            background-image: radial-gradient(circle at top right, #1e1b4b, #070b14); background-attachment: fixed; 
        }

        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: auto; padding-bottom: 50px; }
        header { text-align: center; margin: 15px 0; position: relative; }
        .logo-main { height: 60px; filter: drop-shadow(0 0 10px var(--primary)); }
        
        #refresh-timer { 
            position: absolute; right: 0; top: 0; background: rgba(99, 102, 241, 0.1); 
            padding: 8px 15px; border-radius: 20px; font-size: 11px; border: 1px solid var(--primary); 
            color: var(--primary); font-weight: bold;
        }

        .section-title { 
            font-weight: 800; font-size: 0.75rem; color: var(--primary); margin: 25px 0 10px; 
            border-left: 4px solid var(--primary); padding-left: 12px; text-transform: uppercase; 
            display: flex; justify-content: space-between; align-items: center; 
        }

        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .full { grid-column: span 2; }
        
        /* Estatus de GPS y Trabajo */
        .status-ok { border: 2px solid var(--neon-green) !important; color: var(--neon-green) !important; box-shadow: 0 0 12px rgba(0, 255, 140, 0.3) !important; }
        .status-lejos { border: 2px solid var(--neon-red) !important; color: var(--neon-red) !important; box-shadow: 0 0 12px rgba(255, 0, 85, 0.3) !important; }
        .status-terminado { border: 2px solid var(--neon-blue) !important; color: var(--neon-blue) !important; box-shadow: 0 0 12px rgba(0, 200, 255, 0.3) !important; }

        .staff-tag { padding: 8px 12px; border-radius: 12px; margin: 4px; display: inline-block; font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        .debug-tag { font-size: 9px; display: block; opacity: 0.8; margin-top: 4px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 3px; }

        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: rgba(15, 23, 42, 0.8); color: white; font-size: 14px; box-sizing: border-box; outline: none; }
        .table-container { background: var(--card); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: rgba(0,0,0,0.4); padding: 15px; text-align: left; font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        td { padding: 18px; border-top: 1px solid rgba(255,255,255,0.05); }

        .btn { padding: 10px 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 12px; }
        .btn:active { transform: scale(0.95); }
        .btn-save { background: var(--primary); color: white; width: 100%; margin-top: 15px; justify-content: center; }
        .btn-pay-global { background: var(--warning); color: #000; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }

        /* Login Simple */
        #view_login { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        #receipt-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; background: white; padding: 20px; color: black; }
            .receipt-box { border: 2px solid #000; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; }
        }
@keyframes parpadeo-alerta {
  0% { transform: scale(1); box-shadow: 0 0 5px #ef4444; }
  50% { transform: scale(1.05); box-shadow: 0 0 15px #ef4444; }
  100% { transform: scale(1); box-shadow: 0 0 5px #ef4444; }
}

.alerta-roja {
  animation: parpadeo-alerta 1s infinite;
  border: 2px solid white !important;
}
        
    </style>
</head>
<body>

    <div id="view_login">
        <div class="card" style="width: 300px; text-align: center;">
            <img src="img/logo.png" style="width: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--primary));">
            <h2 style="letter-spacing: 2px;">PANTOJA <span style="color:var(--primary)">ADMIN</span></h2>
            
            <input type="text" id="login_email" placeholder="Usuario / Email" style="margin-bottom: 10px; width: 100%;">
            
            <div style="position: relative; width: 100%; margin-bottom: 5px;">
                <input type="password" id="login_pass" placeholder="Contraseña" style="width: 100%; padding-right: 40px; margin-bottom: 0;">
                <span onclick="togglePass()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary);">
                    <i id="eye_icon" class="fas fa-eye"></i>
                </span>
            </div>

            <div id="debug_info" style="font-size: 10px; color: #666; margin-bottom: 15px; text-align: left; font-family: monospace; min-height: 12px; padding-left: 5px;"></div>

            <button onclick="handleLogin()" class="btn btn-save" style="width: 100%;">ACCEDER AL PANEL</button>
            
            <div id="msg_login" style="font-size: 11px; margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="view_main" class="container hidden">
        <header>
            <div id="refresh-timer">Próximo refresh: <span id="secs">15</span>s</div>
            <img src="img/logo.png" class="logo-main">
            <h2 style="margin:0; letter-spacing: 4px; font-weight: 900;">PANTOJA <span style="color:var(--primary)">TILE</span></h2>
            <small id="txt_bienvenida" style="color: var(--accent); font-weight: bold;"></small>
            <button onclick="logout()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 10px; font-weight: bold;">[ CERRAR SESIÓN ]</button>
        </header>

        <div class="section-title">Registro de Orden</div>
        <div class="card">
            <div class="grid">
                <div><label>ID ORDEN</label><input type="text" id="id_orden" readonly></div>
                <div><label>PRESUPUESTO ($)</label><input type="number" id="presupuesto"></div>
                <div><label>CLIENTE</label><select id="select_cliente" onchange="autoFillCliente()"></select></div>
                <div><label>STAFF INICIAL</label><select id="select_worker" onchange="autoFillWorker()"></select></div>
                <div class="full"><label>DIRECCIÓN</label><input type="text" id="direccion"></div>
                <div class="full"><label>NOTAS ADMIN</label><textarea id="notas_admin" rows="2"></textarea></div>
            </div>
            <button class="btn btn-save" onclick="guardarOrden()"><i class="fas fa-plus-circle"></i> CREAR PROYECTO</button>
            <input type="hidden" id="h_email_cliente"><input type="hidden" id="h_telefono_cliente"><input type="hidden" id="h_servicio_cliente"><input type="hidden" id="h_email_worker">
        </div>

        <div class="section-title">
            Proyectos Activos 
            <button class="btn btn-pay-global" onclick="abrirModalNominaGlobal()"><i class="fas fa-file-invoice-dollar"></i> GENERAR NÓMINA</button>
        </div>

        <div id="dashboard_conteo" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 20px;"></div>
        
        <div class="table-container">
            
            <table>
                <thead>
                    <tr><th>Proyecto / Cliente</th><th>Equipo & GPS Status</th><th>Finanzas</th><th>Acciones</th></tr>
                </thead>
                <tbody id="lista_trabajos"></tbody>
            </table>
        </div>
    </div>

    <div id="modalSelectPay" class="modal">
        <div class="card" style="width:95%; max-width:450px;">
            <h3 style="color:var(--warning); text-align:center;">Payroll System</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div style="flex:1"><label>DESDE</label><input type="date" id="pay_start_date"></div>
                <div style="flex:1"><label>HASTA</label><input type="date" id="pay_end_date"></div>
            </div>
            <label>SELECCIONAR TRABAJADOR</label>
            <select id="pay_select_worker" style="margin-bottom:20px;"></select>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-pay-global" style="flex:1" onclick="ejecutarImpresionNomina()">GENERAR NÓMINA</button>
                <button class="btn" style="flex:1; background:var(--danger); color:white;" onclick="cerrarModales()">CERRAR</button>
            </div>
        </div>
    </div>

    <div id="modalWorker" class="modal">
        <div class="card" style="width:90%; max-width:400px;">
            <h3>Asignar Refuerzo</h3>
            <select id="modal_select_worker" style="margin:15px 0;"></select>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:var(--accent); color:white;" onclick="confirmarNuevoStaff()">ASIGNAR</button>
                <button class="btn" style="flex:1; background:var(--danger); color:white;" onclick="cerrarModales()">SALIR</button>
            </div>
            <input type="hidden" id="modal_order_id">
        </div>
    </div>

    
<script>
   const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbz6RlOsPpJvLKcMktV8a4QTiUTKaSgvIfj6RVeDqj9j3R2VlVYQdwuO6i86Xyacq8Gl/exec"; 
let globalData = { clients: [], users: [], rawJobs: [] };
let timerRef = 15;
let session = null;

window.onload = () => {
    session = JSON.parse(localStorage.getItem('panto_session'));
    if (session && session.success === true) {
        actualizarLogo(session.compania);
        initDashboard();
    } else {
        localStorage.removeItem('panto_session');
    }
};

function actualizarLogo(nombreCompania) {
    const logoImg = document.getElementById('logo_empresa');
    if(!logoImg) return;
    const nombreLimpio = nombreCompania ? nombreCompania.trim().toUpperCase() : "";
    const rutaLogo = nombreLimpio ? `img/${nombreLimpio}.png` : 'img/default_logo.png';
    logoImg.onerror = function() { this.src = 'img/logo_app_generico.png'; };
    logoImg.src = rutaLogo;
}

async function handleLogin() {
    const emailInput = document.getElementById('login_email');
    const passInput = document.getElementById('login_pass');
    const msg = document.getElementById('msg_login');
    const debug = document.getElementById('debug_info');
    const btn = document.querySelector('button[onclick="handleLogin()"]');

    if (msg) msg.innerText = "";
    const email = emailInput.value.trim();
    const pass = passInput.value.trim();
    if (!email || !pass) return alert("Completa los datos");

    msg.innerText = "Verificando credenciales...";
    msg.style.color = "var(--primary)";
    if (btn) btn.disabled = true;
    
    try {
        const url = `${URL_SCRIPT}?action=login_staff&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}&t=${Date.now()}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.success) {
            const rolesAutorizados = ['Admin', 'Master', 'Supervisor'];
            if (rolesAutorizados.includes(data.rol)) {
                localStorage.setItem('panto_session', JSON.stringify(data));
                setTimeout(() => { location.reload(); }, 500);
            } else {
                msg.innerText = "Acceso restringido: " + data.rol;
                msg.style.color = "orange";
                if (btn) btn.disabled = false;
            }
        } else {
            msg.innerText = data.msg || "Credenciales incorrectas";
            msg.style.color = "red";
            if (btn) btn.disabled = false;
        }
    } catch(e) { 
        msg.innerText = "Error de conexión";
        if (btn) btn.disabled = false;
    }
}

function togglePass() {
    const passInput = document.getElementById('login_pass');
    const eyeIcon = document.getElementById('eye_icon');
    if (passInput.type === "password") {
        passInput.type = "text";
        eyeIcon.classList.replace('fa-eye', 'fa-eye-slash');
    } else {
        passInput.type = "password";
        eyeIcon.classList.replace('fa-eye-slash', 'fa-eye');
    }
}
    async function initDashboard() {
    document.getElementById('view_login').classList.add('hidden');
    document.getElementById('view_main').classList.remove('hidden');
    document.getElementById('txt_bienvenida').innerText = `${session.rol}: ${session.name} | ${session.compania}`;
    
    if(session.rol === 'Master' || session.compania === 'TODAS') {
        await initMasterTools();
    }
    cargarConfiguracion();
    cargarTabla();
    
    if (window.miReloj) clearInterval(window.miReloj);
    window.miReloj = setInterval(() => {
        timerRef--;
        const spanSecs = document.getElementById('secs');
        if(spanSecs) spanSecs.innerText = timerRef;
        if(timerRef <= 0) { timerRef = 15; cargarTabla(); }
    }, 1000);
}
 
    async function switchCompany(newComp) {
    session.compania = newComp;
    localStorage.setItem('panto_session', JSON.stringify(session));
    actualizarLogo(newComp);
    document.getElementById('txt_bienvenida').innerText = `${session.rol}: ${session.name} | ${session.compania}`;
    
    if(newComp === "TODAS") {
        document.getElementById('select_cliente').innerHTML = '<option>Seleccione empresa fija</option>';
    } else {
        await cargarConfiguracion(); 
    }
    cargarTabla();
}

async function cargarTabla() {
    try {
        let compBusqueda = session.compania;
        const res = await fetch(`${URL_SCRIPT}?action=get_active_jobs&userCompania=${encodeURIComponent(compBusqueda)}&userRol=${session.rol}&t=${Date.now()}`);
        const trabajos = await res.json();
        globalData.rawJobs = trabajos; 

        const dashboard = document.getElementById("dashboard_conteo");
        if (dashboard && trabajos.length > 0) {
            const conteos = trabajos.reduce((acc, c) => {
                acc[c.compania] = (acc[c.compania] || 0) + 1;
                return acc;
            }, {});
            dashboard.innerHTML = Object.entries(conteos).map(([comp, cant]) => `
                <div onclick="switchCompany('${comp}')" class="dash-card">
                    <div class="dash-comp">${comp}</div>
                    <div class="dash-cant">${cant} <small>Jobs</small></div>
                </div>
            `).join("");
        }

        const tabla = document.getElementById("lista_trabajos");
        if (!trabajos || trabajos.length === 0) {
            tabla.innerHTML = `<tr><td colspan="4" align="center" class="no-data">No hay proyectos activos</td></tr>`;
            return;
        }

        const agrupados = trabajos.reduce((acc, curr) => {
            if (!acc[curr.id]) {
                acc[curr.id] = { id: curr.id, cliente: curr.cliente, presupuesto: curr.presupuesto, equipo: {}, compania: curr.compania, direccion: curr.direccion };
            }
            
            const cleanDist = (val) => {
                if (!val || val === "undefined") return null;
                let m = String(val).match(/[\d.]+/);
                return m ? parseFloat(m[0]) : null;
            };

            let dIn = cleanDist(curr.gps_in_dist || curr.gps_in);
            let hasIn = curr.add_in && String(curr.add_in).length > 2;
            let hasOut = curr.add_out && String(curr.add_out).length > 2;
            let colorFondo = "#374151"; let textoGps = "No Log"; let animacion = "";

            if (hasIn) {
                if (hasOut) {
                    colorFondo = (dIn !== null && dIn <= 0.2) ? "#2563eb" : "#f97316";
                    textoGps = (colorFondo === "#2563eb") ? "P-COMPLET" : "GPS-WARN";
                } else {
                    if (dIn !== null && dIn <= 0.2) { colorFondo = "#10b981"; textoGps = "IN-SITE"; }
                    else { colorFondo = "#ef4444"; textoGps = "OUT-SITE"; animacion = "alerta-roja"; }
                }
            }

            acc[curr.id].equipo[curr.asignado_a] = {
                nombre: curr.asignado_a,
                horas: curr.horas_acumuladas || 0,
                estilo: `background-color: ${colorFondo};`,
                clase: animacion,
                label: `${textoGps} (${dIn !== null ? dIn : '?'})`,
                mapa: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(colorFondo === "#ef4444" ? curr.add_in : curr.direccion)}`
            };
            return acc;
        }, {});

        tabla.innerHTML = Object.values(agrupados).map(t => `
            <tr>
                <td><b>#${t.id}</b><br><span class="badge">${t.compania}</span><br>${t.cliente}</td>
                <td>
                    <div class="team-flex">
                        ${Object.values(t.equipo).map(e => `
                            <div class="staff-tag ${e.clase}" style="${e.estilo}" onclick="window.open('${e.mapa}','_blank')">
                                ${e.nombre}<br><small>${e.label} | ${e.horas}h</small>
                            </div>
                        `).join("")}
                        <button class="add-btn" onclick="prepararAddStaff('${t.id}')">+</button>
                    </div>
                </td>
                <td class="price">$${t.presupuesto}</td>
                <td><button class="done-btn" onclick="cambiarEstatus('${t.id}')">DONE</button></td>
            </tr>
        `).join("");
    } catch (err) { console.error(err); }
}
   // --- MASTER TOOLS ---
async function initMasterTools() {
    const header = document.querySelector('header');
    if (!header || document.getElementById('master_switcher')) return;

    const selectorHTML = `
        <div id="master_switcher" style="margin-top:10px; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; border:1px solid var(--primary);">
            <label style="font-size:10px; color:var(--primary); font-weight:bold;">MODO MASTER: SELECCIONAR EMPRESA</label>
            <select id="master_company_select" onchange="switchCompany(this.value)" style="margin-top:5px; border-color:var(--primary); background: #070b14; color: white; width:100%;">
                <option value="TODAS">-- TODAS LAS EMPRESAS --</option>
            </select>
        </div>
    `;
    header.insertAdjacentHTML('beforeend', selectorHTML);

    try {
        const res = await fetch(`${URL_SCRIPT}?action=get_companies&userRol=${session.rol}`);
        const companies = await res.json();
        const select = document.getElementById('master_company_select');
        let options = '<option value="TODAS">-- TODAS LAS EMPRESAS --</option>';
        options += companies.map(c => `<option value="${c.nombre}" ${c.nombre === session.compania ? 'selected' : ''}>${c.nombre}</option>`).join('');
        select.innerHTML = options;
    } catch (e) { console.error("Error en MasterTools:", e); }
}

// --- CARGAR CONFIGURACIÓN (DROPDOWNS) ---
async function cargarConfiguracion() {
    try {
        const resData = await fetch(`${URL_SCRIPT}?action=get_dropdowns&compania=${encodeURIComponent(session.compania)}&userRol=${session.rol}`);
        const data = await resData.json();
        
        globalData.clients = data.clients;
        globalData.users = data.users;
        
        const resId = await fetch(`${URL_SCRIPT}?action=get_next_id&compania=${encodeURIComponent(session.compania)}`);
        const nextId = await resId.text();
        document.getElementById('id_orden').value = nextId.trim();
        
        document.getElementById('select_cliente').innerHTML = '<option value="">-- Cliente --</option>' + 
            globalData.clients.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            
        document.getElementById('select_worker').innerHTML = '<option value="">-- Staff --</option>' + 
            globalData.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
            
        document.getElementById('pay_select_worker').innerHTML = '<option value="TODOS">-- TODOS --</option>' + 
            globalData.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
            
    } catch(e) { console.error("Error cargando configuración:", e); }
}

function autoFillCliente() {
    const name = document.getElementById('select_cliente').value;
    const client = globalData.clients.find(c => c.name === name);
    if(client) {
        document.getElementById('direccion').value = client.address || ""; // Viene de Mensaje (Col G)
        document.getElementById('notas_admin').value = client.notes || "";   // Viene de Col J
        document.getElementById('h_email_cliente').value = client.email || ""; // Viene de Col E
        document.getElementById('h_telefono_cliente').value = client.phone || ""; // Viene de Col D
        document.getElementById('h_servicio_cliente').value = client.service || ""; // Viene de Col F
        
        // Si tienes un campo para el presupuesto o descuento, podrías usar client.discount
        console.log("Descuento aplicable:", client.discount);
    }
}

function autoFillWorker() {
    const w = globalData.users.find(x => x.name === document.getElementById('select_worker').value);
    if(w) document.getElementById('h_email_worker').value = w.email;
}

async function guardarOrden() {
    const btn = event.currentTarget;
    const originalText = btn.innerHTML;
    const payload = {
        action: 'CREATE_ORDER',
        id: document.getElementById('id_orden').value,
        status: 'Active',
        presupuesto: document.getElementById('presupuesto').value,
        cliente: document.getElementById('select_cliente').value,
        direccion: document.getElementById('direccion').value,
        notas_admin: document.getElementById('notas_admin').value,
        asignado_a: document.getElementById('select_worker').value,
        email_cliente: document.getElementById('h_email_cliente').value,
        telefono: document.getElementById('h_telefono_cliente').value,
        servicio: document.getElementById('h_servicio_cliente').value,
        email_trabajador: document.getElementById('h_email_worker').value,
        compania: session.compania 
    };

    if(!payload.cliente || !payload.asignado_a) return alert("Selecciona Cliente y Staff");

    btn.disabled = true;
    btn.innerHTML = 'GUARDANDO...';

    try {
        const res = await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify(payload) });
        const result = await res.text();
        if (result.includes("SUCCESS")) {
            alert("✅ ¡Orden Creada!");
            location.reload();
        } else {
            alert("❌ " + result);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (e) { alert("Error de conexión"); btn.disabled = false; btn.innerHTML = originalText; }
}
    // --- SISTEMA DE NÓMINA (PAYROLL) ---
async function ejecutarImpresionNomina() {
    const worker = document.getElementById('pay_select_worker').value;
    const start = document.getElementById('pay_start_date').value;
    const end = document.getElementById('pay_end_date').value;
    const btn = event.currentTarget;

    if (!start || !end) return alert("Selecciona fechas");

    btn.disabled = true;
    btn.innerHTML = 'GENERANDO...';

    try {
        const url = `${URL_SCRIPT}?action=get_payroll&worker=${encodeURIComponent(worker)}&start=${start}&end=${end}&compania=${encodeURIComponent(session.compania)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data || data.length === 0) {
            alert("No hay registros.");
            btn.disabled = false;
            btn.innerHTML = "GENERAR NÓMINA";
            return;
        }

        generarReciboHTML(data, worker, start, end);
    } catch (e) {
        console.error(e);
        alert("Error de nómina");
        btn.disabled = false;
        btn.innerHTML = "GENERAR NÓMINA";
    }
}

function generarReciboHTML(datos, worker, start, end) {
    const area = document.getElementById('receipt-area') || document.body;
    const ventImpresion = window.open('', '_blank');
    
    let totalGeneral = 0;
    const filas = datos.map(r => {
        totalGeneral += parseFloat(r.horas || 0);
        return `<tr><td>${r.fecha}</td><td>#${r.id_orden} - ${r.cliente}</td><td>${r.horas}h</td></tr>`;
    }).join("");

    ventImpresion.document.write(`
        <html>
        <head><title>Payroll - ${worker}</title>
        <style>
            body { font-family: sans-serif; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            .total { font-weight: bold; font-size: 1.2em; margin-top: 20px; }
        </style>
        </head>
        <body>
            <h1>Recibo de Pago</h1>
            <p>Trabajador: ${worker}</p>
            <p>Periodo: ${start} al ${end}</p>
            <table>
                <thead><tr><th>Fecha</th><th>Proyecto</th><th>Horas</th></tr></thead>
                <tbody>${filas}</tbody>
            </table>
            <p class="total">Total de Horas: ${totalGeneral.toFixed(2)}h</p>
            <p>Empresa: ${session.compania}</p>
        </body>
        </html>
    `);
    ventImpresion.document.close();
    ventImpresion.print();
    
    const btn = document.querySelector('button[onclick="ejecutarImpresionNomina()"]');
    if(btn) { btn.disabled = false; btn.innerHTML = "GENERAR NÓMINA"; }
}

async function cambiarEstatus(idOrden) {
    if (!confirm(`¿Cerrar orden #${idOrden}?`)) return;
    try {
        const res = await fetch(`${URL_SCRIPT}?action=cambiar_estatus&id=${idOrden}`);
        const data = await res.json();
        if (data.success) {
            alert("✅ Finalizada.");
            cargarTabla();
        }
    } catch (e) { alert("Error"); }
}

function logout() {
    localStorage.clear();
    location.reload();
}

function cerrarModales() { 
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); 
}

// --- FINAL DEL SCRIPT ---
console.log("Sistema Pantoja cargado correctamente.");
</script>
</body>
</html>
