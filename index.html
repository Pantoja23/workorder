<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pantoja Elite | Master Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #6366f1; 
            --bg: #070b14; 
            --card: rgba(30, 41, 59, 0.7); 
            --text: #f8fafc; 
            --accent: #22c55e; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --neon-blue: #00c8ff; 
            --neon-green: #00ff8c; 
            --neon-red: #ff0055;
        }

        header h2, .section-title, .btn-save, #master_switcher, .logo-main {
            transition: color 0.6s ease, border-color 0.6s ease, filter 0.6s ease, box-shadow 0.6s ease;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 15px; 
            background-image: radial-gradient(circle at top right, #1e1b4b, #070b14); 
            background-attachment: fixed; 
        }

        .hidden { display: none !important; }
        .container { max-width: 1100px; margin: auto; padding-bottom: 50px; }
        header { text-align: center; margin: 15px 0; position: relative; }
        
        .logo-main { 
            height: 60px; 
            filter: drop-shadow(0 0 15px var(--primary)); 
        }
        
        .auth-btn {
            background: linear-gradient(45deg, #d4af37, #b8860b);
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
        }
        
        #refresh-timer { 
            position: absolute; right: 0; top: 0; background: rgba(99, 102, 241, 0.1); 
            padding: 8px 15px; border-radius: 20px; font-size: 11px; border: 1px solid var(--primary); 
            color: var(--primary); font-weight: bold;
        }

        .section-title { 
            font-weight: 800; font-size: 0.75rem; color: var(--primary); margin: 25px 0 10px; 
            border-left: 4px solid var(--primary); padding-left: 12px; text-transform: uppercase; 
            display: flex; justify-content: space-between; align-items: center; 
        }

        .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .full { grid-column: span 2; }
        
        .status-ok { border: 2px solid var(--neon-green) !important; color: var(--neon-green) !important; box-shadow: 0 0 12px rgba(0, 255, 140, 0.3) !important; }
        .status-lejos { border: 2px solid var(--neon-red) !important; color: var(--neon-red) !important; box-shadow: 0 0 12px rgba(255, 0, 85, 0.3) !important; }

        .staff-tag { padding: 8px 12px; border-radius: 12px; margin: 4px; display: inline-block; font-size: 12px; font-weight: bold; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }

        input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #334155; background: rgba(15, 23, 42, 0.8); color: white; font-size: 14px; box-sizing: border-box; outline: none; }
        .table-container { background: var(--card); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: rgba(0,0,0,0.4); padding: 15px; text-align: left; font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        td { padding: 18px; border-top: 1px solid rgba(255,255,255,0.05); }

        .btn { padding: 10px 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.3s; font-size: 12px; }
        .btn-save { background: var(--primary); color: white; width: 100%; margin-top: 15px; justify-content: center; }
        .btn-pay-global { background: var(--warning); color: #000; }
        .done-btn { background: var(--accent); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .add-btn { background: var(--primary); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; }
        
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }

        #view_login { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        @keyframes parpadeo-alerta {
          0% { transform: scale(1); box-shadow: 0 0 5px #ef4444; }
          50% { transform: scale(1.05); box-shadow: 0 0 15px #ef4444; }
          100% { transform: scale(1); box-shadow: 0 0 5px #ef4444; }
        }
        .alerta-roja { animation: parpadeo-alerta 1s infinite; border: 2px solid white !important; }

        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
        }
    </style>
</head>
<body>

    <div id="view_login">
        <div class="card" style="width: 300px; text-align: center;">
            <img src="img/logo.png" style="width: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px var(--primary));">
            <h2 style="letter-spacing: 2px;">PANTOJA <span style="color:var(--primary)">ADMIN</span></h2>
            <input type="text" id="login_email" placeholder="Usuario / Email" style="margin-bottom: 10px; width: 100%;">
            <div style="position: relative; width: 100%; margin-bottom: 15px;">
                <input type="password" id="login_pass" placeholder="Contraseña" style="width: 100%; padding-right: 40px;">
                <span onclick="togglePass()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--primary);">
                    <i id="eye_icon" class="fas fa-eye"></i>
                </span>
            </div>
            <button onclick="handleLogin()" class="btn btn-save" style="width: 100%;">ACCEDER AL PANEL</button>
            <div id="msg_login" style="font-size: 11px; margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="view_main" class="container hidden">
        <header>
            <div id="refresh-timer">Próximo refresh: <span id="secs">15</span>s</div>
            <img src="img/logo.png" id="logo_empresa" class="logo-main">
            <h2 id="header_titulo" style="margin:0; letter-spacing: 2px; font-weight: 900; text-transform: uppercase;">
                <span id="nombre_empresa_dinamico" style="color:var(--primary);">PANTOJA ADMIN</span>
            </h2>
            <small id="txt_bienvenida" style="color: var(--text); font-weight: bold; opacity: 0.7;"></small>
            <button onclick="logout()" style="background: none; border: none; color: var(--danger); cursor: pointer; font-size: 10px; font-weight: bold; display: block; margin: 5px auto;">[ CERRAR SESIÓN ]</button>
        </header>

        <div class="section-title">Registro de Orden</div>
        <div class="card">
            <div class="grid">
                <div><label>ID ORDEN</label><input type="text" id="id_orden" readonly></div>
                <div><label>PRESUPUESTO ($)</label><input type="number" id="presupuesto"></div>
                <div><label>CLIENTE</label><select id="select_cliente" onchange="autoFillCliente()"></select></div>
                <div><label>STAFF INICIAL</label><select id="select_worker" onchange="autoFillWorker()"></select></div>
                <div class="full"><label>DIRECCIÓN</label><input type="text" id="direccion"></div>
                <div class="full"><label>NOTAS ADMIN</label><textarea id="notas_admin" rows="2"></textarea></div>
            </div>
            <button class="btn btn-save" onclick="guardarOrden()"><i class="fas fa-plus-circle"></i> CREAR PROYECTO</button>
            <input type="hidden" id="h_email_cliente">
            <input type="hidden" id="h_telefono_cliente">
            <input type="hidden" id="h_servicio_cliente">
            <input type="hidden" id="h_email_worker">
        </div>

        <div class="section-title">
            Proyectos Activos 
            <button class="btn btn-pay-global" onclick="abrirModalNominaGlobal()"><i class="fas fa-file-invoice-dollar"></i> GENERAR NÓMINA</button>
        </div>

        <div id="dashboard_conteo" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; margin-bottom: 20px;"></div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Proyecto / Cliente</th><th>Equipo & GPS Status</th><th>Finanzas</th><th>Acciones</th></tr>
                </thead>
                <tbody id="lista_trabajos"></tbody>
            </table>
        </div>
    </div>

    <div id="modalSelectPay" class="modal">
        <div class="card" style="width:95%; max-width:450px;">
            <h3 style="color:var(--warning); text-align:center;">Payroll System</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <div style="flex:1"><label>DESDE</label><input type="date" id="pay_start_date"></div>
                <div style="flex:1"><label>HASTA</label><input type="date" id="pay_end_date"></div>
            </div>
            <label>SELECCIONAR TRABAJADOR</label>
            <select id="pay_select_worker" style="margin-bottom:20px;"></select>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-pay-global" style="flex:1" onclick="ejecutarImpresionNomina()">GENERAR NÓMINA</button>
                <button class="btn" style="flex:1; background:var(--danger); color:white;" onclick="cerrarModales()">CERRAR</button>
            </div>
        </div>
    </div>

    <div id="modalWorker" class="modal">
        <div class="card" style="width:90%; max-width:400px;">
            <h3>Asignar Refuerzo</h3>
            <select id="modal_select_worker" style="margin:15px 0;"></select>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:var(--accent); color:white;" onclick="confirmarNuevoStaff()">ASIGNAR</button>
                <button class="btn" style="flex:1; background:var(--danger); color:white;" onclick="cerrarModales()">SALIR</button>
            </div>
            <input type="hidden" id="modal_order_id">
        </div>
    </div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxg9UUVKYDQXBBWPH_vCb8rQV1zcXOBfT5NH-5YqBilqG8YRrrSM0HlAnApQWglRMaE/exec"; 
let globalData = { clients: [], users: [], rawJobs: [] };
let timerRef = 15;
let session = null;
let masterCompanyData = {};

window.onload = async () => {
    const saved = localStorage.getItem('panto_session');
    if (saved) {
        session = JSON.parse(saved);
        if (session && session.success) {
            document.getElementById('view_login').classList.add('hidden');
            document.getElementById('view_main').classList.remove('hidden');
            
            // PRIMERO cargamos las empresas para tener los colores y datos
            await cargarConfiguracionEmpresaIndividual(); 
            
            // LUEGO inicializamos herramientas de Master si aplica
            if (["Master", "Supervisor", "Admin", "LandLord", "Trabajador"].includes(session.rol)) {
    await initMasterTools();
}
            
            // FINALMENTE mostramos los datos del usuario
            document.getElementById('txt_bienvenida').innerText = `${session.rol}: ${session.name}`;
            switchCompany(session.compania);
            initDashboard();
        }
    }
};

async function handleLogin() {
    const email = document.getElementById('login_email').value.trim();
    const pass = document.getElementById('login_pass').value.trim();
    const msg = document.getElementById('msg_login');
    if (!email || !pass) return alert("Completa los datos");

    msg.innerText = "Verificando...";
    try {
        const res = await fetch(`${URL_SCRIPT}?action=login_staff&email=${encodeURIComponent(email)}&pass=${encodeURIComponent(pass)}&t=${Date.now()}`);
        const data = await res.json();
        if (data.success) {
            localStorage.setItem('panto_session', JSON.stringify(data));
            location.reload();
        } else {
            msg.innerText = data.msg || "Error";
        }
    } catch(e) { msg.innerText = "Error de conexión"; }
}

function togglePass() {
    const p = document.getElementById('login_pass');
    const i = document.getElementById('eye_icon');
    p.type = p.type === "password" ? "text" : "password";
    i.classList.toggle('fa-eye'); i.classList.toggle('fa-eye-slash');
}

function initDashboard() {
    document.getElementById('txt_bienvenida').innerText = `${session.rol}: ${session.name}`;
    cargarConfiguracion();
    cargarTabla();
    setInterval(() => {
        timerRef--;
        if(document.getElementById('secs')) document.getElementById('secs').innerText = timerRef;
        if(timerRef <= 0) { timerRef = 15; cargarTabla(); }
    }, 1000);
}

async function switchCompany(newComp) {
    session.compania = newComp;
    localStorage.setItem('panto_session', JSON.stringify(session));
    aplicarTemaEmpresa(newComp);
    const txtEmpresa = document.getElementById('nombre_empresa_dinamico');
    if(txtEmpresa) txtEmpresa.innerText = newComp === "TODAS" ? "PANTOJA ADMIN" : newComp;
    document.getElementById('logo_empresa').src = `img/${newComp}.png`;
    cargarTabla();
}

function aplicarTemaEmpresa(nombreComp) {
    let color = (masterCompanyData[nombreComp]?.color) || "#6366f1";
    document.documentElement.style.setProperty('--primary', color);
}

async function cargarTabla() {
    try {
        // Añadimos userEmail=${encodeURIComponent(session.email)} a la URL
        const res = await fetch(`${URL_SCRIPT}?action=get_active_jobs&userCompania=${encodeURIComponent(session.compania)}&userRol=${session.rol}&userEmail=${encodeURIComponent(session.email)}&t=${Date.now()}`);
        const trabajos = await res.json();
        globalData.rawJobs = trabajos;

        const dashboard = document.getElementById("dashboard_conteo");
        if (dashboard && trabajos.length > 0) {
            const conteos = trabajos.reduce((acc, c) => { acc[c.compania] = (acc[c.compania] || 0) + 1; return acc; }, {});
            dashboard.innerHTML = Object.entries(conteos).map(([comp, cant]) => `
                <div onclick="switchCompany('${comp}')" style="cursor:pointer; background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; border:1px solid var(--primary);">
                    <div style="font-size:10px;">${comp}</div>
                    <div style="font-weight:bold;">${cant} Jobs</div>
                </div>`).join("");
        }

        const agrupados = trabajos.reduce((acc, curr) => {
            if (!acc[curr.id]) {
                acc[curr.id] = { id: curr.id, cliente: curr.cliente, presupuesto: curr.presupuesto, equipo: {}, compania: curr.compania, direccion: curr.direccion, status: curr.status };
            }
            const cleanDist = (val) => {
                if (!val || val === "undefined") return null;
                let m = String(val).match(/[\d.]+/);
                return m ? parseFloat(m[0]) : null;
            };
            let dIn = cleanDist(curr.gps_in_dist);
            let hasIn = curr.add_in && curr.add_in.length > 2;
            let hasOut = curr.add_out && curr.add_out.length > 2;
            let color = "#374151"; let txt = "No Log"; let anim = "";
            if (hasIn) {
                if (hasOut) { color = (dIn <= 0.2) ? "#2563eb" : "#f97316"; txt = "DONE"; }
                else { color = (dIn <= 0.2) ? "#10b981" : "#ef4444"; txt = (dIn <= 0.2) ? "IN-SITE" : "OUT-SITE"; if(dIn>0.2) anim="alerta-roja"; }
            }
            
            // CORRECCIÓN AQUÍ: Se eliminó la llave extra y se cerró correctamente el objeto
            acc[curr.id].equipo[curr.asignado_a] = { 
                nombre: curr.asignado_a, 
                horas: curr.horas_acumuladas || 0, 
                estilo: `background-color: ${color};`, 
                clase: anim, 
                label: `${txt} (${dIn ?? '?'})`, 
                mapa: "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(curr.direccion)
            };
            return acc;
        }, {});

        const tabla = document.getElementById("lista_trabajos");
        tabla.innerHTML = Object.values(agrupados).map(t => {
            let botonAccion = "";
            if (t.status === "ON APPROVAL") {
                if (["LandLord", "Admin", "Master"].includes(session.rol)) {
                    botonAccion = `<button class="auth-btn" onclick="cambiarEstatus('${t.id}', 'Active')">AUTHORIZE</button>`;
                } else {
                    botonAccion = `<span style="color:var(--warning); font-size:10px; font-weight:bold;">AWAITING...</span>`;
                }
            } else {
                botonAccion = `<button class="done-btn" onclick="cambiarEstatus('${t.id}', 'Done')">DONE</button>`;
            }

            return `<tr>
                <td><b>#${t.id}</b><br><span style="font-size:10px; color:var(--primary)">${t.compania}</span><br>${t.cliente}</td>
                <td>
                    <div style="display:flex; flex-wrap:wrap; gap:5px;">
                        ${Object.values(t.equipo).map(e => `<div class="staff-tag ${e.clase}" style="${e.estilo}" onclick="window.open('${e.mapa}')">${e.nombre}<br><small>${e.label} | ${e.horas}h</small></div>`).join("")}
                        <button class="add-btn" onclick="prepararAddStaff('${t.id}')">+</button>
                    </div>
                </td>
                <td style="font-weight:bold; color:var(--accent)">$${t.presupuesto}</td>
                <td>${botonAccion}</td>
            </tr>`;
        }).join("");
    } catch (e) { 
        console.error("Error en cargarTabla:", e); 
    }
}

async function cargarConfiguracion() {
    try {
        // Le pasamos el ROL al servidor para que sepa si darnos clientes o no
        const res = await fetch(`${URL_SCRIPT}?action=get_dropdowns&compania=${encodeURIComponent(session.compania)}&rol=${session.rol}`);
        const data = await res.json();
        
        globalData.clients = data.clients || [];
        globalData.users = data.users || [];

        const selectCliente = document.getElementById('select_cliente');
        const selectWorker = document.getElementById('select_worker');

        // LÓGICA DE CLIENTES: Si es LandLord, lo dejamos vacío inicialmente (se llenará al autorizar)
        if (session.rol === "LandLord") {
            selectCliente.innerHTML = '<option value="">-- Bloqueado para Autorizar --</option>';
        } else {
            selectCliente.innerHTML = '<option value="">-- Cliente --</option>' + 
                globalData.clients.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }

        // LÓGICA DE STAFF: Llenamos a todos, pero LandLord usará a Jorge
        selectWorker.innerHTML = '<option value="">-- Staff --</option>' + 
            globalData.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');

        // Dropdown de nómina (Pay)
        const payWorker = document.getElementById('pay_select_worker');
        if(payWorker) {
            payWorker.innerHTML = '<option value="TODOS">-- TODOS --</option>' + 
                globalData.users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        }

        // ID de Orden (Solo si no es LandLord, porque el LandLord usa el ID de la tabla)
        if (session.rol !== "LandLord") {
            const resId = await fetch(`${URL_SCRIPT}?action=get_next_id&compania=${encodeURIComponent(session.compania)}`);
            document.getElementById('id_orden').value = (await resId.text()).trim();
        }
    } catch(e) { console.error("Error en configuración:", e); }
}

function autoFillCliente() {
    const c = globalData.clients.find(x => x.name === document.getElementById('select_cliente').value);
    if(c) {
        document.getElementById('direccion').value = c.address || "";
        document.getElementById('notas_admin').value = c.notes || "";
        document.getElementById('h_email_cliente').value = c.email || "";
        document.getElementById('h_telefono_cliente').value = c.phone || "";
        document.getElementById('h_servicio_cliente').value = c.service || "";
    }
}

function autoFillWorker() {
    const w = globalData.users.find(x => x.name === document.getElementById('select_worker').value);
    if(w) document.getElementById('h_email_worker').value = w.email;
}

async function guardarOrden() {
    const btn = event.currentTarget;
    
    // Capturamos los valores directamente del elemento, no importa si está disabled
    const id = document.getElementById('id_orden').value;
    const presupuesto = document.getElementById('presupuesto').value;
    const cliente = document.getElementById('select_cliente').value;
    const worker = document.getElementById('select_worker').value;

    // VALIDACIÓN "ANTI-ERROR"
    if (!presupuesto || parseFloat(presupuesto) <= 0) {
        alert("¡Error! Debes ingresar un monto de presupuesto.");
        return;
    }

    // Si cliente o worker vienen vacíos (por el bloqueo), los rescatamos
    if (!cliente || !worker) {
        alert("Faltan datos críticos: Cliente o Staff. Intente seleccionar la orden de nuevo.");
        return;
    }

    const payload = {
        action: 'UPDATE_OR_CREATE_ORDER', 
        id: id,
        status: 'ACTIVE',
        presupuesto: presupuesto,
        cliente: cliente,
        direccion: document.getElementById('direccion').value,
        notas_admin: document.getElementById('notas_admin').value,
        asignado_a: worker,
        email_cliente: document.getElementById('h_email_cliente').value,
        telefono: document.getElementById('h_telefono_cliente').value,
        servicio: document.getElementById('h_servicio_cliente').value,
        email_trabajador: document.getElementById('h_email_worker').value,
        compania: session.compania
    };

    btn.disabled = true;
    btn.innerText = "Autorizando Proyecto...";

    try {
        // Quitamos no-cors para ver errores reales si ocurren
        const res = await fetch(URL_SCRIPT, { 
            method: 'POST', 
            body: JSON.stringify(payload) 
        });

        const texto = await res.text();
        
        if (texto.includes("SUCCESS")) {
            alert("¡Proyecto #" + id + " Autorizado con éxito!");
            // IMPORTANTE: Desbloquear antes de recargar
            document.getElementById('select_cliente').disabled = false;
            document.getElementById('select_worker').disabled = false;
            location.reload(); 
        } else {
            alert("Error del servidor: " + texto);
            btn.disabled = false;
            btn.innerText = "CREAR PROYECTO";
        }

    } catch(e) {
        alert("Error de conexión. Revisa el nuevo Script URL.");
        btn.disabled = false;
        btn.innerText = "CREAR PROYECTO";
    }
}

async function cambiarEstatus(id, nuevoEstatus) {
    if (nuevoEstatus === 'Active') {
        // Buscamos la orden en los datos cargados
        const orden = globalData.rawJobs.find(j => String(j.id) === String(id));
        
        if (!orden) {
            alert("No se encontró la información del proyecto #" + id);
            return;
        }

        // 1. Llenamos los campos visibles
        document.getElementById('id_orden').value = orden.id;
        document.getElementById('direccion').value = orden.direccion || "";
        document.getElementById('presupuesto').value = ""; // Limpiamos para que el LandLord lo ponga

        // 2. Formateamos las Notas: (F) Servicio - (I) Notas Admin
        const servicioText = orden.servicio || "N/A";
        const notasPrevias = orden.notas_admin || "";
        document.getElementById('notas_admin').value = `(F) ${servicioText} - (I) ${notasPrevias}`;

        // 3. Forzamos la selección del Cliente en el select
        const selectCliente = document.getElementById('select_cliente');
        selectCliente.innerHTML = `<option value="${orden.cliente}" selected>${orden.cliente}</option>`;
        selectCliente.disabled = true; // Bloqueado para seguridad

        // 4. Forzamos a Jorge Pantoja como Staff predeterminado
        const selectWorker = document.getElementById('select_worker');
        selectWorker.innerHTML = `<option value="Jorge Pantoja" selected>Jorge Pantoja</option>`;
        selectWorker.disabled = true;

        // 5. Buscamos el email de Jorge en la lista de usuarios global
        const staffObj = globalData.users.find(u => u.name.includes("Jorge Pantoja"));
        if (staffObj) {
            document.getElementById('h_email_worker').value = staffObj.email;
        } else {
            // Backup por si no lo encuentra en la lista
            document.getElementById('h_email_worker').value = "jorgepantoja@example.com"; 
        }

        // 6. Llenamos datos ocultos del cliente
        document.getElementById('h_email_cliente').value = orden.email_cliente || "";
        document.getElementById('h_servicio_cliente').value = orden.servicio || "";

        // 7. UI: Scroll al inicio y cambiar texto del botón
        window.scrollTo({ top: 0, behavior: 'smooth' });
        const btnCrear = document.querySelector("button[onclick='guardarOrden()']");
        if(btnCrear) {
            btnCrear.innerText = "CONFIRMAR AUTORIZACIÓN ✅";
            btnCrear.style.backgroundColor = "#10b981"; // Cambia a verde para indicar acción positiva
        }

        setTimeout(() => document.getElementById('presupuesto').focus(), 500);
        
    } else if (nuevoEstatus === 'Done') {
        if(!confirm(`¿Deseas marcar la orden #${id} como finalizada?`)) return;
        try {
            const res = await fetch(`${URL_SCRIPT}?action=cambiar_estatus&id=${id}&nuevo=Done`);
            const texto = await res.text();
            if(texto.includes("SUCCESS")) {
                alert("Orden #" + id + " finalizada correctamente.");
                cargarTabla();
            }
        } catch(e) { alert("Error de conexión al finalizar."); }
    }
}

async function ejecutarImpresionNomina() {
    const worker = document.getElementById('pay_select_worker').value;
    const start = document.getElementById('pay_start_date').value;
    const end = document.getElementById('pay_end_date').value;
    if(!start || !end) return alert("Fechas obligatorias");
    try {
        const res = await fetch(`${URL_SCRIPT}?action=get_payroll&worker=${encodeURIComponent(worker)}&start=${start}&end=${end}&compania=${encodeURIComponent(session.compania)}`);
        const data = await res.json();
        let total = 0;
        let html = `<h1>Payroll: ${worker}</h1><table border="1" style="width:100%"><tr><th>Fecha</th><th>ID</th><th>Horas</th></tr>`;
        data.forEach(r => { total += parseFloat(r.horas); html += `<tr><td>${r.fecha}</td><td>${r.id_orden}</td><td>${r.horas}h</td></tr>`; });
        html += `</table><h3>Total: ${total.toFixed(2)}h</h3>`;
        const win = window.open('', '_blank');
        win.document.write(html); win.print();
    } catch(e) { alert("Error al generar"); }
}

async function initMasterTools() {
    // Protección extra: si no es de los roles permitidos, no hace nada
    if (!["Master", "Supervisor", "Admin"].includes(session.rol)) return;

    const res = await fetch(`${URL_SCRIPT}?action=get_companies`);
    const companies = await res.json();
    companies.forEach(c => masterCompanyData[c.nombre] = c);
    
    const header = document.querySelector('header');
    
    // Si ya existe el switcher, no lo duplicamos
    if (document.getElementById('master_switcher')) return;

    const select = `
        <div id="master_switcher" style="margin-top: 10px;">
            <select onchange="switchCompany(this.value)" style="padding: 5px; border-radius: 5px; background: #1e293b; color: white; border: 1px solid var(--primary);">
                <option value="${session.compania}">-- Mi Empresa --</option>
                ${session.rol === "Master" ? '<option value="TODAS">-- TODAS --</option>' : ''}
                ${companies.map(c => `<option value="${c.nombre}">${c.nombre}</option>`).join("")}
            </select>
        </div>`;
    header.insertAdjacentHTML('beforeend', select);
}
async function cargarConfiguracionEmpresaIndividual() {
    const res = await fetch(`${URL_SCRIPT}?action=get_companies`);
    (await res.json()).forEach(c => masterCompanyData[c.nombre] = c);
}

function prepararAddStaff(id) {
    document.getElementById('modal_order_id').value = id;
    document.getElementById('modal_select_worker').innerHTML = globalData.users.map(u => `<option value="${u.name}" data-email="${u.email}">${u.name}</option>`).join('');
    document.getElementById('modalWorker').style.display = 'flex';
}

async function confirmarNuevoStaff() {
    const sel = document.getElementById('modal_select_worker');
    const payload = {
        action: 'ADD_STAFF',
        id: document.getElementById('modal_order_id').value,
        asignado_a: sel.value,
        email_trabajador: sel.options[sel.selectedIndex].dataset.email,
        compania: session.compania
    };
    await fetch(URL_SCRIPT, { method: 'POST', body: JSON.stringify(payload) });
    cerrarModales(); cargarTabla();
}

function cerrarModales() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
