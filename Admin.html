<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantoja Tile | Master Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #6366f1; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #4ade80; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin:0; }
        .container { max-width: 900px; margin: auto; }
        .card { background: var(--card); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; box-shadow: 0 10px 15px rgba(0,0,0,0.3); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full { grid-column: span 2; }
        label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; outline: none; font-size: 15px; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }
        textarea { height: 90px; resize: none; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        .btn-add { background: #22c55e; color: white; width: 100%; padding: 16px; margin-top: 15px; font-size: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-add:hover { background: #16a34a; transform: translateY(-2px); }
        .btn-add:disabled { background: #475569; cursor: not-allowed; transform: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; color: #94a3b8; padding: 12px; border-bottom: 2px solid #334155; font-size: 12px; }
        td { padding: 12px; border-bottom: 1px solid #334155; font-size: 14px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; }
        .active { background: rgba(74, 222, 128, 0.1); color: #4ade80; }
        .done { background: rgba(148, 163, 184, 0.1); color: #94a3b8; }
        .btn-action { padding: 7px 11px; border-radius: 6px; font-size: 11px; color: white; margin-left: 4px; }
        
        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; }
            .full { grid-column: span 1; }
        }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; padding: 20px 0;">
        <h1 style="margin: 0; color: var(--primary);">PANTOJA TILE ADMIN</h1>
        <p style="color: #64748b;">Gestión de Órdenes | Panel Central</p>
    </header>

    <div class="card">
        <h2 style="margin-top:0;"><i class="fas fa-file-invoice" style="color: var(--primary); margin-right: 10px;"></i> Nueva PTR-Work Order</h2>
        <div class="grid">
            <div>
                <label>ID Orden</label>
                <input type="text" id="id" readonly style="color: var(--accent); font-weight: bold; background: #0f172a;">
            </div>

            <div>
                <label>Seleccionar Cliente (Sheet1)</label>
                <select id="selectCliente" onchange="autoFillCliente()">
                    <option value="">Cargando lista de clientes...</option>
                </select>
            </div>

            <div>
                <label>Asignar Trabajador (Users)</label>
                <select id="selectWorker" onchange="autoFillWorker()">
                    <option value="">Cargando lista de trabajadores...</option>
                </select>
            </div>

            <div class="full">
                <label>Dirección del Proyecto</label>
                <input type="text" id="dir" placeholder="Escriba la dirección donde se realizará el trabajo">
            </div>

            <div class="full">
                <label>Notas e Instrucciones para el Trabajador</label>
                <textarea id="desc" placeholder="Detalles de materiales, áreas a cubrir, etc."></textarea>
            </div>
        </div>

        <input type="hidden" id="email_cliente">
        <input type="hidden" id="telefono_cliente">
        <input type="hidden" id="servicio_cliente">
        <input type="hidden" id="email_worker">

        <button class="btn-add" id="btnGuardar" onclick="crearOrden()">
            <i class="fas fa-check-circle"></i> GUARDAR Y REGISTRAR EN EXCEL
        </button>
    </div>

    <div class="card">
        <h2 style="margin-top:0;"><i class="fas fa-history" style="color: var(--primary); margin-right: 10px;"></i> Historial de Órdenes</h2>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Cliente</th>
                        <th>Trabajador</th>
                        <th>Estatus</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla">
                    <tr><td colspan="5" style="text-align:center;">Iniciando sistema...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // URL DE TU ÚLTIMO DESPLIEGUE (NEW DEPLOYMENT)
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbx-9fzIrMUkR2lag-vnyoWKSE6JWSsvLtTHi8Wy3wxiwQCr9N_qek5Er52nOP1b9ALY-Q/exec"; 
    let globalDropdowns = {};

    async function init() {
        try {
            // 1. Cargar el ID PTRWO siguiente
            const resId = await fetch(`${URL_SCRIPT}?action=get_next_id`);
            const nextId = await resId.text();
            document.getElementById('id').value = nextId;

            // 2. Cargar datos de Sheet1 y Users para los dropdowns
            const resDrop = await fetch(`${URL_SCRIPT}?action=get_dropdowns`);
            globalDropdowns = await resDrop.json();

            // Llenar selector de Clientes
            const selCli = document.getElementById('selectCliente');
            selCli.innerHTML = '<option value="">-- Seleccione Cliente --</option>';
            globalDropdowns.clients.forEach(c => {
                selCli.innerHTML += `<option value="${c.name}">${c.name}</option>`;
            });

            // Llenar selector de Trabajadores
            const selWork = document.getElementById('selectWorker');
            selWork.innerHTML = '<option value="">-- Seleccione Trabajador --</option>';
            globalDropdowns.users.forEach(u => {
                selWork.innerHTML += `<option value="${u.name}">${u.name}</option>`;
            });

            cargarTabla();
        } catch(e) { 
            console.error("Error cargando dropdowns:", e);
            alert("Error al conectar con la base de datos.");
        }
    }

    // Al elegir cliente, se llenan los campos que irán al Excel
    function autoFillCliente() {
        const nombre = document.getElementById('selectCliente').value;
        const cli = globalDropdowns.clients.find(c => c.name === nombre);
        if(cli) {
            document.getElementById('email_cliente').value = cli.email || "";
            document.getElementById('telefono_cliente').value = cli.phone || "";
            document.getElementById('servicio_cliente').value = cli.service || "";
        }
    }

    // Al elegir trabajador, se llena su email de login automáticamente
    function autoFillWorker() {
        const nombre = document.getElementById('selectWorker').value;
        const user = globalDropdowns.users.find(u => u.name === nombre);
        if(user) {
            document.getElementById('email_worker').value = user.email || "";
        }
    }

    async function cargarTabla() {
        try {
            const res = await fetch(URL_SCRIPT);
            const data = await res.json();
            const cuerpo = document.getElementById('cuerpoTabla');
            cuerpo.innerHTML = '';

            if(data.length === 0) {
                cuerpo.innerHTML = '<tr><td colspan="5" style="text-align:center;">No hay órdenes registradas.</td></tr>';
                return;
            }

            data.forEach(o => {
                cuerpo.innerHTML += `
                    <tr>
                        <td><b>${o.id}</b></td>
                        <td>${o.nombre_cliente || 'N/A'}</td>
                        <td>${o.asignado_a || 'N/A'}</td>
                        <td><span class="badge ${o.estatus}">${o.estatus.toUpperCase()}</span></td>
                        <td>
                            <button class="btn-action" style="background:#3b82f6;" onclick="imprimir('${o.id}')"><i class="fas fa-print"></i></button>
                        </td>
                    </tr>`;
            });
        } catch(e) { console.error("Error tabla:", e); }
    }

    async function crearOrden() {
        const btn = document.getElementById('btnGuardar');
        const payload = {
            action: 'CREATE_ORDER',
            id: document.getElementById('id').value,
            cliente: document.getElementById('selectCliente').value,
            email_cliente: document.getElementById('email_cliente').value,
            telefono: document.getElementById('telefono_cliente').value,
            servicio: document.getElementById('servicio_cliente').value,
            direccion: document.getElementById('dir').value,
            asignado_a: document.getElementById('selectWorker').value,
            email_trabajador: document.getElementById('email_worker').value,
            description_admin: document.getElementById('desc').value
        };

        if(!payload.cliente || !payload.asignado_a || !payload.direccion) {
            return alert("Por favor complete: Cliente, Trabajador y Dirección.");
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        try {
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            alert("Orden registrada con éxito.");
            location.reload(); 
        } catch(e) {
            alert("Error al guardar.");
            btn.disabled = false;
            btn.innerText = "GUARDAR Y REGISTRAR EN EXCEL";
        }
    }

    function imprimir(id) {
        alert("Generando vista previa para impresión del ID: " + id);
        // Aquí puedes llamar a tu lógica de impresión anterior
    }

    window.onload = init;
</script>
</body>
</html>